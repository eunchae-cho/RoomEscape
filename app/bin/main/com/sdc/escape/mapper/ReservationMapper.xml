<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

  <mapper namespace="com.sdc.escape.dao.ReservationDao">
    <resultMap type="reservation" id="ReservationMap">
       <id column="res_no" property="no"></id>
        <result column="res_time" property="roomTime"></result>
        <result column="res_rdt" property="reservatedDate"></result>
         <result column="res_date" property="doDate"></result>
        <result column="res_cancel" property="cancel"></result>
        <result column="res_cancel_date" property="canceledDate"></result>
        <result column="res_participant" property="participant"></result>
        <result column="res_price" property="price"></result>
        <result column="u_no" property="uno"></result>
        <result column="r_no" property="rno"></result>
        <result column="res_status" property="status"></result>
        
        <association property="room" javaType="room">
        	<id column="r_no" property="no"></id>
        	<result column="r_title" property="title"></result>
        </association>
    </resultMap>

    <select id="findAll" resultMap="ReservationMap">
    </select>
    
    <select id="findByUno" resultMap="ReservationMap" parameterType="int">
    	SELECT
    			res_no
    		,	res_time
    		,	res_rdt
    		,	res_cancel
    		,	res_cancel_date
    		,	res_participant
    		,	res_price
    		,	res.u_no
    		,	res.r_no
    		,	res_status
    		,	r.r_title r_title
    	FROM escape_reservation res
    		INNER JOIN escape_user u
    			ON res.u_no = u.u_no
    		INNER JOIN escape_room r
    			ON res.r_no = r.r_no
     	WHERE res.u_no = #{no}
    	ORDER BY res_rdt DESC
    </select>
    
    <select id="findByNo" resultMap="ReservationMap" parameterType="int">
    	SELECT
    			res_no
    		,	res_time
    		,	res_rdt
    		,	res_cancel
    		,	res_cancel_date
    		,	res_participant
    		,	res_price
    		,	res.u_no
    		,	res.r_no
    		,	res_status
    		,	r.r_title r_title
    	FROM escape_reservation res
    		INNER JOIN escape_user u
    			ON res.u_no = u.u_no
    		INNER JOIN escape_room r
    			ON res.r_no = r.r_no
     	WHERE res_no = #{no}
    	ORDER BY res_rdt DESC
    </select>
    
    <select id="findReservation" resultMap="ReservationMap" parameterType="Date">
    	SELECT 
    			r_no
    		,	res_time
    		,	res_date
    	FROM  escape_reservation
    	WHERE res_date = #{date} 
    		AND res_cancel = 0
    
    </select>
    
    <insert id="add" parameterType="Reservation">
     	INSERT INTO escape_reservation
     		(res_time, res_rdt, res_participant, res_price, u_no, r_no)
     	VALUES
     		(#{roomTime}, #{reservatedDate}, #{participant}, #{price}, #{uno}, #{rno})
    </insert>
    
    <update id="updateCancel" parameterType="Reservation">
    	UPDATE escape_reservation
	    	SET
	    			res_cancel = #{cancel}
	    		,	res_cancel_date = now()
	    		,	res_status = #{status}
    	WHERE res_no = #{no}
    </update>
  </mapper>